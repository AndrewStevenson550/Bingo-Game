<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Bingo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase JS SDKs -->
    <script type="module">
        // Ensure you have a __firebase_config variable available in your environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // Fallback config now uses your provided values
                apiKey: "AIzaSyAGksnY4y7xJ-6awhFY8PhYgNlpiO8fchQ",
                authDomain: "bingo-97637.firebaseapp.com",
                projectId: "bingo-97637",
                storageBucket: "bingo-97637.firebasestorage.app",
                messagingSenderId: "344260607387",
                appId: "1:344260607387:web:9bfed1c6558851c69f353e",
                measurementId: "G-XRJ75CMLMK"
            };

        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, arrayUnion, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // App ID (for Firestore rules)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bingo-app';

        // Global state
        let currentUserId = null;
        let currentGameId = null;
        let currentPlayerId = null;
        let currentUsername = null;
        let gameListener = null; // Unsubscribe function for game snapshot
        let playersListener = null; // Unsubscribe function for players snapshot
        let myBoardListener = null; // Unsubscribe function for player's board snapshot
        
        // --- NEW FLOW ---
        // Initialize myBoard with 25 empty slots
        let myBoard = Array(25).fill(null).map((_, i) => ({
            text: i === 12 ? "FREE SPACE" : "", // Pre-fill free space
            marked: i === 12 // Pre-mark free space
        }));
        let currentGameState = 'BOARD_CREATION'; // BOARD_CREATION, HOST_GAME, PLAYER_GAME
        let selectedSquareIndex = -1;

        // --- DOM Elements ---
        const views = {
            loading: document.getElementById('loading-view'),
            boardCreation: document.getElementById('board-creation-view'),
            host: document.getElementById('host-view'),
            player: document.getElementById('player-view')
        };
        
        // Board Creation
        const boardCreationGrid = document.getElementById('board-creation-grid');
        const createGameButton = document.getElementById('create-game-btn');
        const joinGameButton = document.getElementById('join-game-btn');

        // Host
        const hostGameCode = document.getElementById('host-game-code');
        const hostBoardGrid = document.getElementById('host-board-grid');
        const hostPlayersList = document.getElementById('host-players-list');
        const hostUserIdDisplay = document.getElementById('host-user-id');

        // Player
        const playerBoardGrid = document.getElementById('player-board-grid');
        const playerCalledItemsList = document.getElementById('player-called-items-list');
        const bingoButton = document.getElementById('bingo-button');
        const playerUserIdDisplay = document.getElementById('player-user-id');

        // Modals
        const winModal = document.getElementById('win-modal');
        const winModalText = document.getElementById('win-modal-text');
        const newGameButton = document.getElementById('new-game-button');
        
        const editSquareModal = document.getElementById('edit-square-modal');
        const editSquareForm = document.getElementById('edit-square-form');
        const editSquareInput = document.getElementById('edit-square-input');
        const cancelEditSquareBtn = document.getElementById('cancel-edit-square-btn');
        
        const joinGameModal = document.getElementById('join-game-modal');
        const joinGameForm = document.getElementById('join-game-form');
        const cancelJoinGameBtn = document.getElementById('cancel-join-game-btn');
        
        const createGameModal = document.getElementById('create-game-modal');
        const createGameForm = document.getElementById('create-game-form');
        const cancelCreateGameBtn = document.getElementById('cancel-create-game-btn');

        // AI Scanner Elements
        const scanBoardButton = document.getElementById('scan-board-btn');
        const fileInput = document.getElementById('upload-bingo-image');
        const scanLoading = document.getElementById('scan-loading');


        // --- Utility Functions ---

        /**
         * Shows a specific view and hides all others.
         * @param {string} viewName - The key of the view to show (e.g., 'auth', 'host').
         */
        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        }

        /**
         * Generates a random 6-character alphanumeric code.
         */
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /**
         * Shuffles an array in place (Fisher-Yates shuffle).
         */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Checks if a string is a URL pointing to an image.
         * @param {string} url - The string to check.
         */
        function isImageUrl(url) {
            if (typeof url !== 'string') return false;
            // Simple check for image extensions
            return url.startsWith('http') && (url.endsWith('.png') || url.endsWith('.jpg') || url.endsWith('.jpeg') || url.endsWith('.gif') || url.endsWith('.webp'));
        }

        /**
         * Shows a custom modal alert.
         * @param {string} message - The message to display.
         */
        function showModalAlert(message) {
            winModalText.textContent = message;
            winModal.classList.remove('hidden');
            // Hide the 'new game' button for simple alerts
            newGameButton.classList.add('hidden');
            
            // Add a temporary click listener to hide it
            const closeAlertHandler = () => {
                winModal.classList.add('hidden');
                newGameButton.classList.remove('hidden'); // Reset button
                winModal.removeEventListener('click', closeAlertHandler);
            };
            setTimeout(() => {
                winModal.addEventListener('click', closeAlertHandler);
            }, 500); // Add a small delay
        }

        /**
         * Renders a square's content (text or image)
         * @param {object} square - The square object {text, marked}
         * @returns {string} HTML content for the square
         */
        function getSquareContent(square) {
            if (square.text === "FREE SPACE") {
                return `<span class="font-bold text-blue-700">FREE SPACE</span>`;
            } else if (isImageUrl(square.text)) {
                return `<img src="${square.text}" alt="Bingo Item" class="w-full h-full object-cover">`;
            } else {
                return `<span class="p-1 text-center">${square.text}</span>`;
            }
        }

        // --- NEW AI/HELPER FUNCTIONS ---

        /**
         * Delays execution for a given number of milliseconds.
         */
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Fetches a URL with exponential backoff for retrying on 429 errors.
         */
        async function fetchWithBackoff(apiUrl, options, retries = 3, delayMs = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 429) { // Throttling
                        console.warn(`API request throttled. Retrying in ${delayMs}ms...`);
                        await delay(delayMs);
                        delayMs *= 2; // Exponential backoff
                        continue;
                    }
                    console.error(`API request failed with status ${response.status}:`, await response.text());
                    return null; // Non-retryable error
                } catch (error) {
                    console.error("Fetch error:", error);
                }
            }
            console.error("API request failed after all retries.");
            return null;
        }

        /**
         * Scans a bingo board image using the Gemini API and returns a structured list of squares.
         */
        async function scanBingoBoard(base64ImageData, mimeType) {
            // NOTE: apiKey is an empty string. The environment will provide it.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Extract the text from the 25 squares of this bingo board. Provide the text for the 25 squares in order from left-to-right, top-to-bottom. The center square is often a 'FREE SPACE'. Respond with a JSON object containing a single key 'squares' which is an array of 25 strings. If a square is blank, use an empty string. The array must have exactly 25 elements." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "squares": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" },
                                "description": "An array of exactly 25 strings, representing the text in each square of the bingo board from left to right, top to bottom."
                            }
                        }
                    }
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const result = await fetchWithBackoff(apiUrl, options);

            if (!result) {
                throw new Error("API request failed or returned null.");
            }

            const part = result?.candidates?.[0]?.content?.parts?.[0];
            if (part && part.text) {
                const parsedJson = JSON.parse(part.text);
                // Validate the response
                if (parsedJson.squares && Array.isArray(parsedJson.squares) && parsedJson.squares.length === 25) {
                    return parsedJson;
                } else {
                    console.error("Invalid JSON schema from AI:", parsedJson);
                    throw new Error("AI response was not in the expected format (missing 'squares' array of 25).");
                }
            } else {
                console.error("Invalid API response structure:", result);
                throw new Error("Invalid or empty response from AI model.");
            }
        }

        // --- Authentication ---

        /**
         * Initializes the application, signs in the user, and sets up auth state listener.
         */
        async function initApp() {
            setLogLevel('Debug');
            showView('loading');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User signed in with UID:", currentUserId);
                    // NEW FLOW: Go to board creation, not auth view
                    setupBoardCreationView();
                } else {
                    console.log("No user signed in, attempting anonymous sign-in.");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showModalAlert("Could not connect. Please refresh.");
                    }
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                showModalAlert("Authentication failed. Please refresh.");
            }
        }

        // --- Board Creation View ---

        /**
         * Sets up the initial board creation view
         */
        function setupBoardCreationView() {
            currentGameState = 'BOARD_CREATION';
            renderBoardCreationGrid();
            showView('boardCreation');
        }

        /**
         * Renders the user's board in the creation view
         */
        function renderBoardCreationGrid() {
            boardCreationGrid.innerHTML = '';
            myBoard.forEach((square, index) => {
                const div = document.createElement('div');
                let classes = "flex items-center justify-center border rounded-lg aspect-square text-xs sm:text-sm shadow-sm overflow-hidden break-words cursor-pointer hover:bg-gray-50";
                
                div.innerHTML = getSquareContent(square);

                if (!square.text || (square.text === "FREE SPACE" && index !== 12)) {
                    classes += " bg-gray-100";
                    div.innerHTML = `<span class="text-gray-400 text-lg">+</span>`
                } else if (square.text === "FREE SPACE") {
                    classes += " bg-blue-100";
                }

                div.className = classes;
                
                // Allow editing any square *except* the free space
                if (index !== 12) {
                    div.addEventListener('click', () => showEditSquareModal(index));
                }

                boardCreationGrid.appendChild(div);
            });
        }

        /**
         * Shows the modal to edit a square
         * @param {number} index - The board index (0-24) to edit
         */
        function showEditSquareModal(index) {
            if (index === 12) return; // Cannot edit free space
            selectedSquareIndex = index;
            editSquareInput.value = myBoard[index].text;
            editSquareModal.classList.remove('hidden');
            editSquareInput.focus();
        }

        // Event listener for saving the edited square
        editSquareForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newText = editSquareInput.value.trim();
            if (selectedSquareIndex > -1 && newText) {
                myBoard[selectedSquareIndex].text = newText;
                myBoard[selectedSquareIndex].marked = false; // Reset marked status
            }
            editSquareModal.classList.add('hidden');
            selectedSquareIndex = -1;
            renderBoardCreationGrid(); // Re-render the board
        });

        cancelEditSquareBtn.addEventListener('click', () => {
            editSquareModal.classList.add('hidden');
            selectedSquareIndex = -1;
        });

        /**
         * Checks if the board is fully filled out (all 24 squares + free space)
         */
        function isBoardComplete() {
            return myBoard.every(square => square.text && square.text.trim() !== "");
        }

        // --- AI Board Scanner Listeners ---
        scanBoardButton.addEventListener('click', () => {
            fileInput.click(); // Open file dialog
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Simple type check
            if (!file.type.startsWith('image/')) {
                showModalAlert("Please select an image file (png, jpg, etc).");
                return;
            }

            scanLoading.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64Full = event.target.result;
                const mimeType = file.type;
                const base64Data = base64Full.split(',')[1];
                
                try {
                    const result = await scanBingoBoard(base64Data, mimeType);
                    // Populate myBoard
                    myBoard = result.squares.map((text, index) => ({
                        text: text.trim() === '' ? (index === 12 ? 'FREE SPACE' : '') : text.trim(),
                        marked: index === 12 // Mark free space
                    }));
                    
                    // Ensure free space is correct
                    myBoard[12] = { text: "FREE SPACE", marked: true };
                    
                    // Re-render
                    renderBoardCreationGrid();
                } catch (error) {
                    console.error("Error scanning board:", error);
                    showModalAlert("Sorry, I couldn't read that bingo board. Please try again or fill it out manually.");
                } finally {
                    scanLoading.classList.add('hidden');
                    fileInput.value = null; // Reset file input
                }
            };
            reader.onerror = () => {
                console.error("Error reading file.");
                showModalAlert("Could not read the selected file.");
                scanLoading.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        });


        // --- Game Logic (Create & Join) ---

        // Show Modals
        createGameButton.addEventListener('click', () => {
            if (!isBoardComplete()) {
                showModalAlert("Please fill out all 24 squares on your board before creating a game!");
                return;
            }
            createGameModal.classList.remove('hidden');
        });
        cancelCreateGameBtn.addEventListener('click', () => createGameModal.classList.add('hidden'));

        joinGameButton.addEventListener('click', () => {
             // MODIFICATION: Removed isBoardComplete() check.
             // You can now join without a full board.
            joinGameModal.classList.remove('hidden');
        });
        cancelJoinGameBtn.addEventListener('click', () => joinGameModal.classList.add('hidden'));


        /**
         * Handles the "Create Game" form submission.
         */
        createGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showModalAlert("Not authenticated.");

            const formData = new FormData(createGameForm);
            const hostUsername = formData.get('host-username').trim();
            if (!hostUsername) return showModalAlert("Please enter a username.");

            createGameModal.classList.add('hidden');
            showView('loading');
            currentUsername = hostUsername;

            try {
                const gameCode = generateGameCode();
                const gameRef = collection(db, `artifacts/${appId}/public/data/bingoGames`);
                
                const gameDoc = await addDoc(gameRef, {
                    gameCode: gameCode,
                    hostId: currentUserId,
                    hostBoard: myBoard, // Use the host's created board as the master list
                    calledItems: [],
                    winner: null,
                    createdAt: serverTimestamp()
                });

                currentGameId = gameDoc.id;

                const playersRef = collection(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}/players`);
                await addDoc(playersRef, {
                    userId: currentUserId,
                    username: hostUsername,
                    isHost: true
                });

                console.log("Game created with ID:", currentGameId, "and Code:", gameCode);
                setupHostView(gameCode);

            } catch (error) {
                console.error("Error creating game:", error);
                showModalAlert("Failed to create game. Please try again.");
                setupBoardCreationView(); // Go back to board creation
            }
        });

        /**
         * Handles the "Join Game" form submission.
         */
        joinGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showModalAlert("Not authenticated.");

            const formData = new FormData(joinGameForm);
            const gameCode = formData.get('join-code').trim().toUpperCase();
            const username = formData.get('join-username').trim();

            if (!gameCode || !username) return showModalAlert("Please enter a code and username.");
            
            joinGameModal.classList.add('hidden');
            showView('loading');
            currentUsername = username;

            try {
                const gamesRef = collection(db, `artifacts/${appId}/public/data/bingoGames`);
                const q = query(gamesRef, where("gameCode", "==", gameCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showModalAlert("Game not found.");
                    showView('boardCreation');
                    return;
                }

                const gameDoc = querySnapshot.docs[0];
                currentGameId = gameDoc.id;
                const gameData = gameDoc.data(); // Get game data

                const playersRef = collection(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}/players`);
                const playerQuery = query(playersRef, where("userId", "==", currentUserId));
                const playerQuerySnapshot = await getDocs(playerQuery);

                if (playerQuerySnapshot.empty) {
                    // New player, create their board
                    let playerBoardToSave;

                    if (isBoardComplete()) {
                        // User filled out their own board
                        playerBoardToSave = myBoard;
                        console.log("Saving player's custom board.");
                    } else {
                        // User did not fill out board, create one from host
                        console.log("Generating randomized board from host's items.");
                        if (!gameData.hostBoard || gameData.hostBoard.length !== 25) {
                            showModalAlert("Error: Host board is invalid. Cannot join game.");
                            setupBoardCreationView();
                            return;
                        }
                        
                        // Get host's items, filter out free space
                        let hostItems = gameData.hostBoard.map(square => square.text)
                                                            .filter(text => text !== "FREE SPACE");
                        
                        // Shuffle and create a new 24-item list
                        let shuffledItems = shuffle([...hostItems]);
                        
                        // Re-insert FREE SPACE at index 12
                        shuffledItems.splice(12, 0, "FREE SPACE");

                        // Create the board object
                        playerBoardToSave = shuffledItems.map((item, index) => ({
                            text: item,
                            marked: index === 12 // Pre-mark free space
                        }));
                    }

                    const playerDoc = await addDoc(playersRef, {
                        userId: currentUserId,
                        username: username,
                        isHost: false,
                        board: playerBoardToSave // Save the correct board
                    });
                    currentPlayerId = playerDoc.id;
                    myBoard = playerBoardToSave; // Set global myBoard to what was saved
                } else {
                    // Returning player
                    const playerDoc = playerQuerySnapshot.docs[0];
                    currentPlayerId = playerDoc.id;
                    myBoard = playerDoc.data().board; // Load their board from server
                    console.log("Returning player, loaded board.");
                }

                setupPlayerView();

            } catch (error) {
                console.error("Error joining game:", error);
                showModalAlert("Failed to join game. Please try again.");
                setupBoardCreationView();
            }
        });

        // --- Host View ---

        /**
         * Sets up the Host view.
         * @param {string} gameCode - The game code to display.
         */
        function setupHostView(gameCode) {
            currentGameState = 'HOST_GAME';
            hostGameCode.textContent = gameCode;
            hostUserIdDisplay.textContent = `Your User ID: ${currentUserId}`;
            
            // Render the host's board as the call grid
            hostBoardGrid.innerHTML = '';
            let calledItems = [];

            myBoard.forEach((square, index) => {
                const button = document.createElement('button');
                button.dataset.item = square.text;
                button.dataset.index = index;
                button.className = "flex items-center justify-center border rounded-lg aspect-square text-xs sm:text-sm shadow-sm overflow-hidden break-words focus:outline-none focus:ring-2 focus:ring-blue-500";
                
                button.innerHTML = getSquareContent(square);

                if (square.text === "FREE SPACE") {
                     button.className += " bg-blue-500 text-white font-bold opacity-100"; // Pre-mark free space
                     button.disabled = true;
                } else {
                     button.className += " bg-white hover:bg-blue-50 cursor-pointer";
                }
                
                button.addEventListener('click', () => {
                    if (!calledItems.includes(square.text)) {
                        callItem(square.text);
                    }
                });
                hostBoardGrid.appendChild(button);
            });

            // Listen for game state changes (called items and winner)
            const gameRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}`);
            gameListener = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const gameData = docSnap.data();
                calledItems = gameData.calledItems || [];

                // Update called item button styles
                hostBoardGrid.querySelectorAll('button').forEach(btn => {
                    if (calledItems.includes(btn.dataset.item) && btn.dataset.item !== "FREE SPACE") {
                        btn.classList.add('bg-gray-300', 'text-gray-500', 'line-through');
                        btn.classList.remove('bg-white', 'hover:bg-blue-50');
                        btn.disabled = true;
                    }
                });

                if (gameData.winner) {
                    showWinner(gameData.winner.username);
                }
            });

            // Listen for players joining
            const playersRef = collection(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}/players`);
            playersListener = onSnapshot(playersRef, (querySnapshot) => {
                hostPlayersList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const player = doc.data();
                    const li = document.createElement('li');
                    li.textContent = `${player.username} ${player.isHost ? '(Host)' : ''}`;
                    li.className = "bg-gray-100 p-2 rounded";
                    hostPlayersList.appendChild(li);
                });
            });
            
            showView('host');
        }

        /**
         * Host calls an item, updating Firestore.
         * @param {string} item - The item text to call.
         */
        async function callItem(item) {
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}`);
                await updateDoc(gameRef, {
                    calledItems: arrayUnion(item)
                });
            } catch (error) {
                console.error("Error calling item:", error);
            }
        }

        // --- Player View ---

        /**
         * Sets up the Player view with board and listeners.
         */
        function setupPlayerView() {
            currentGameState = 'PLAYER_GAME';
            playerUserIdDisplay.textContent = `Your User ID: ${currentUserId}`;

            // Listen for game state changes (called items and winner)
            const gameRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}`);
            gameListener = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) return showModalAlert("Game data error.");
                
                const gameData = docSnap.data();
                const calledItems = gameData.calledItems || [];

                // Update the list of called items
                playerCalledItemsList.innerHTML = calledItems.length > 0
                    ? calledItems.map(item => {
                        if (isImageUrl(item)) {
                            return `<li class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 bg-gray-100 flex-shrink-0"><img src="${item}" alt="Called Item" class="w-full h-full object-cover"></li>`;
                        } else {
                            return `<li class="px-3 py-1 bg-gray-200 rounded-full text-sm flex-shrink-0">${item}</li>`;
                        }
                    }).join('')
                    : '<li class="text-gray-500">No items called yet...</li>';

                renderPlayerBoard(calledItems);

                if (gameData.winner) {
                    showWinner(gameData.winner.username);
                }
            });

            // Listen for changes to *my* board (e.g., from another device)
            const myBoardRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}/players/${currentPlayerId}`);
            myBoardListener = onSnapshot(myBoardRef, (docSnap) => {
                if (docSnap.exists()) {
                    myBoard = docSnap.data().board;
                    // We need the calledItems list to render correctly
                    getDoc(gameRef).then(gameDoc => {
                        const calledItems = gameDoc.data().calledItems || [];
                        renderPlayerBoard(calledItems);
                        checkBingo(); // Check for bingo every time board updates
                    });
                }
            });

            showView('player');
        }

        /**
         * Renders the 5x5 player board.
         * @param {Array} calledItems - The list of called items.
         */
        function renderPlayerBoard(calledItems) {
            playerBoardGrid.innerHTML = '';
            myBoard.forEach((square, index) => {
                const div = document.createElement('div');
                div.dataset.index = index;
                div.innerHTML = getSquareContent(square);

                let classes = "flex items-center justify-center border rounded-lg aspect-square text-xs sm:text-sm shadow-sm overflow-hidden break-words";
                
                // Set styling based on state
                if (square.marked) {
                    classes += " bg-blue-500 text-white font-bold opacity-100";
                    if(isImageUrl(square.text)) classes += " ring-4 ring-blue-600 ring-inset";
                } else if (calledItems.includes(square.text) || square.text === "FREE SPACE") {
                    // Markable (called or free space)
                    classes += " bg-white hover:bg-blue-100 cursor-pointer";
                    if(isImageUrl(square.text)) classes += " opacity-60 hover:opacity-100";
                } else {
                    // Not markable
                    classes += " bg-gray-100 text-gray-400";
                     if(isImageUrl(square.text)) classes += " opacity-30";
                }
                div.className = classes;

                if (!square.marked && (calledItems.includes(square.text) || square.text === "FREE SPACE")) {
                    div.addEventListener('click', () => markSquare(index));
                }

                playerBoardGrid.appendChild(div);
            });
        }

        /**
         * Player marks a square on their board.
         * @param {number} index - The index of the square to mark.
         */
        async function markSquare(index) {
            if (myBoard[index].marked) return;
            myBoard[index].marked = true;
            
            try {
                const myBoardRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}/players/${currentPlayerId}`);
                await updateDoc(myBoardRef, {
                    board: myBoard
                });
            } catch (error) {
                console.error("Error marking square:", error);
                myBoard[index].marked = false; // Revert
            }
        }

        /**
         * Checks the player's board for a winning line.
         */
        function checkBingo() {
            const lines = [
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];

            let hasBingo = false;
            for (const line of lines) {
                if (line.every(index => myBoard[index].marked)) {
                    hasBingo = true;
                    break;
                }
            }

            if (hasBingo) {
                bingoButton.classList.remove('hidden');
            } else {
                bingoButton.classList.add('hidden');
            }
        }

        /**
         * Player claims BINGO!
         */
        bingoButton.addEventListener('click', async () => {
            try {
                checkBingo(); // Double-check
                if (bingoButton.classList.contains('hidden')) return;

                const gameRef = doc(db, `artifacts/${appId}/public/data/bingoGames/${currentGameId}`);
                const gameSnap = await getDoc(gameRef);
                if (gameSnap.data().winner) return showModalAlert("Someone just beat you to it!");

                await updateDoc(gameRef, {
                    winner: {
                        username: currentUsername,
                        userId: currentUserId
                    }
                });
            } catch (error) {
                console.error("Error claiming bingo:", error);
            }
        });

        // --- Win & Reset ---

        /**
         * Shows the full-screen winner modal.
         * @param {string} username - The winner's username.
         */
        function showWinner(username) {
            if (gameListener) gameListener();
            if (playersListener) playersListener();
            if (myBoardListener) myBoardListener();
            gameListener = playersListener = myBoardListener = null;

            winModalText.textContent = `${username} got a BINGO!`;
            winModal.classList.remove('hidden');
            winModal.classList.add('animate-flash');
        }

        /**
         * Resets the game by reloading the page.
         */
        newGameButton.addEventListener('click', () => {
            window.location.reload();
        });

        // --- Start App ---
        initApp();

    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Winner modal flashing animation */
        @keyframes flash {
            0%, 100% { background-color: rgba(16, 185, 129, 0.9); } /* emerald-500 */
            50% { background-color: rgba(255, 255, 255, 0.9); }
        }
        .animate-flash {
            animation: flash 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Top Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-30">
        <div class="container mx-auto max-w-4xl p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">Firebase Bingo</h1>
            <div class="flex space-x-2">
                <button id="create-game-btn" class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors text-sm">
                    Create Game
                </button>
                <button id="join-game-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
                    Join Game
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-4xl">

        <!-- Loading View -->
        <div id="loading-view" class="text-center p-10">
            <p class="text-2xl font-semibold text-gray-700">Connecting...</p>
        </div>

        <!-- Board Creation View -->
        <div id="board-creation-view" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <h2 class="text-2xl font-bold text-gray-800">1. Create Your Board</h2>
                    <div class="flex flex-col items-end">
                        <input type="file" id="upload-bingo-image" class="hidden" accept="image/*">
                        <button id="scan-board-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors text-sm">
                            Scan Board from Image
                        </button>
                        <p id="scan-loading" class="text-sm text-gray-500 hidden animate-pulse">Scanning, please wait...</p>
                    </div>
                </div>
                <p class="text-gray-600 mb-4">Click any square to add text/images. Or, use the "Scan Board" button. You must fill all 24 squares to host. You can join a game with a blank board to get a random one.</p>
                <div id="board-creation-grid" class="grid grid-cols-5 gap-2 border-4 border-gray-300 p-2 rounded-lg bg-gray-50">
                    <!-- Board creation grid generated here -->
                </div>
            </div>
            <div class="text-center">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">2. Start Playing!</h2>
                 <p class="text-gray-600 mb-4">Once your board is full, use the buttons at the top of the page to create or join a game.</p>
            </div>
        </div>

        <!-- Host View -->
        <div id="host-view" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <h2 class="text-2xl font-bold text-gray-800">Your Game is Live!</h2>
                <p class="text-lg text-gray-600 mt-2">Share this code with your players:</p>
                <div class="my-4 p-4 bg-gray-100 border-dashed border-2 border-gray-300 rounded-lg">
                    <span id="host-game-code" class="text-5xl font-bold text-blue-600 tracking-widest"></span>
                </div>
                <p id="host-user-id" class="text-xs text-gray-500"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Call Items Grid -->
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Your Board (Click to Call Items)</h3>
                    <div id="host-board-grid" class="grid grid-cols-5 gap-2">
                        <!-- Host board will be generated here -->
                    </div>
                </div>
                <!-- Players List -->
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Players Joined</h3>
                    <ul id="host-players-list" class="space-y-2">
                        <!-- Player list will be generated here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Player View -->
        <div id="player-view" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Your Bingo Board</h2>
                    <button id="bingo-button" class="hidden bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg animate-pulse hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        BINGO!
                    </button>
                </div>
                <p id="player-user-id" class="text-xs text-gray-500 mb-4"></p>
                <div id="player-board-grid" class="grid grid-cols-5 gap-2 border-4 border-blue-300 p-2 rounded-lg bg-blue-50">
                    <!-- Player board will be generated here -->
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-4">Called Items</h3>
                <ul id="player-called-items-list" class="flex flex-wrap gap-2 items-center">
                    <!-- Called items will be listed here -->
                </ul>
            </div>
        </div>

        <!-- === MODALS === -->

        <!-- Win Modal Overlay -->
        <div id="win-modal" class="dialog hidden" aria-modal="true">
            <div class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="relative w-full max-w-md p-8 bg-white rounded-lg shadow-2xl text-center">
                    <h2 id="win-modal-text" class="text-4xl font-bold text-gray-900 mb-6"></h2>
                    <button id="new-game-button" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        Play Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Square Modal -->
        <div id="edit-square-modal" class="dialog hidden" aria-modal="true">
            <div class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <form id="edit-square-form" class="relative w-full max-w-md p-6 bg-white rounded-lg shadow-2xl">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Edit Square</h2>
                    <div class="mb-4">
                        <label for="edit-square-input" class="block text-sm font-medium text-gray-700 mb-1">Text or Image URL</label>
                        <input type="text" id="edit-square-input" name="square-content" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'Team Meeting' or 'http://...' " required>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-edit-square-btn" class="w-1/2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Join Game Modal -->
        <div id="join-game-modal" class="dialog hidden" aria-modal="true">
            <div class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <form id="join-game-form" class="relative w-full max-w-md p-6 bg-white rounded-lg shadow-2xl">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Join Game</h2>
                    <div class="mb-4">
                        <label for="join-code" class="block text-sm font-medium text-gray-700 mb-1">Game Code</label>
                        <input type="text" id="join-code" name="join-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ABC123" required>
                    </div>
                    <div class="mb-4">
                        <label for="join-username" class="block text-sm font-medium text-gray-700 mb-1">Your Username</label>
                        <input type="text" id="join-username" name="join-username" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Player1" required>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-join-game-btn" class="w-1/2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Join
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Create Game Modal -->
        <div id="create-game-modal" class="dialog hidden" aria-modal="true">
            <div class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <form id="create-game-form" class="relative w-full max-w-md p-6 bg-white rounded-lg shadow-2xl">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Create Game</h2>
                    <div class="mb-4">
                        <label for="host-username" class="block text-sm font-medium text-gray-700 mb-1">Your Host Username</label>
                        <input type="text" id="host-username" name="host-username" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="BingoMaster" required>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-create-game-btn" class="w-1/2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="w-1/2 bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</body>
</html>


